os.loadAPI("frame")
frame.init()
term.clear()
term.setCursorPos(1,1)
area_focus = 0
cursor_focus = 1
x, y = term.getSize()
print("CCJam2016 version, for most recent version, find topic on CC forums")
print("Author: Supernicejohn")
print("Press any key to continue...")
os.pullEvent("key")
text = {} -- All text is stored in here
meta = {} -- Any additional info is stored here
do
   local i = 0
   while true do
      i = i + 1
      text[i] = ">"
      if i > 512 then
         break
      end
   end
end
local function load(path) -- load a textfile
   local abspath = shell.resolve(path)
   if fs.exists == nil then
       error("Error -43 - File Not Found")
   else
      if fs.getSize(path) > 65535 then
         error("Error -19 -File Too Large")
      end
      local file = fs.open(abspath, "r")
      local i = 1
      while true do
         text[i] = file.readLine()
         if text[i] == nil then
            file.close()
            break
         end
         i = i + 1
      end
      if fs.exists(abspath..".meta") then -- load metadata
         i = 1
         filemeta = fs.open(abspath..".meta")
         while true do
            meta[i] = filemeta.readLine()
            if meta[i] == nil then
               filemeta.close()
               break
            end
            i = i + 1
         end
      end
   end
end
local function save(path) -- save a file
   if not string.find(path, "/") then
      path = "/Texty/"..path
   end
   local i = 1
   saveto = fs.open(path, "w")
   while true do
      if not text[i] == nil then
         saveto.writeLine(text[i])
         i = i + 1
      else
         saveto.close()
         break
      end
   end
   if fs.exists(path..".meta") then
      local filemeta = fs.open(path..".meta", "w") -- and its metadata
      local i = 1
      while true do
         filemeta.writeLine(meta[i])                 
         i = i + 1
         if meta[i] == nil then
            filemeta.close()
            break
         end
      end
   end
end
local function input() -- main typing function
   while true do
      local e = {os.pullEventRaw()}
      if e[1] == "char" then
         text[cursor_focus+area_focus] = text[cursor_focus+area_focus]..e[2]
      elseif e[1] == "key" then
         if e[2] == keys.backspace then
            if text[cursor_focus+area_focus] == nil then
               focus("-1")
               return
            elseif #text[cursor_focus+area_focus] > 1 then
               text[cursor_focus+area_focus] = text[cursor_focus+area_focus]:sub(1,#text[cursor_focus+area_focus]-1)
               frame.sett(#text[cursor_focus+area_focus]+1,cursor_focus," ")
            end
         elseif e[2] == keys.up then
            focus("-1")
            return
         elseif e[2] == keys.down then
             focus("1")
             return
         elseif e[2] == keys.enter then
            focus("1")
            return
         elseif e[2] == keys.f1 then
            save(fileName)
            return
         elseif e[2] == keys.f2 then
            local c = ":                                                                      "
            frame.setText(12,y,c:sub(1,x-12))
            frame.drawAll()
            term.setCursorPos(13,y)
            save(read())
            frame.drawAll()
         end
      end
      frame.setText(1, cursor_focus, text[cursor_focus+area_focus])
      frame.drawAll()
   end
end

function focus(dir) -- screen and cursor position
   if dir == "1" then
      if cursor_focus < y-1 then
         cursor_focus = cursor_focus + 1
      else
         area_focus = area_focus + 5
         cursor_focus = cursor_focus - 4
      end
   end
   if dir == "-1" then
      if cursor_focus > 1 then
         cursor_focus = cursor_focus - 1
      elseif area_focus > 0 then
         area_focus = area_focus - 5
         if not cursor_focus == 1 then
            cursor_focus = cursor_focus - 1
         end
         if area_focus < 0 then
            area_focus = 0
         end
      end
   end
end
while true do -- main loop
   frame.init()
   local i = 1
   frame.setText(2,2,"Texty")
   frame.setText(3,3,"CCJam2016")
   frame.setText(4,4,"New textfile")
   frame.setText(5,5,"Load textfile")
   frame.setText(6,6,"Exit")
   frame.setText(2,y-2,"f1: Save | f2: Save as")
   frame.setText(2,y-1,"f3: Main menu | INS: tap, alt code")
   while true do
      frame.sett(3,4," ")
      frame.sett(4,5," ")
      frame.sett(5,6," ")
      frame.sett(i+2,i+3,">")
      frame.drawAll()
      local e = {os.pullEvent("key")}
      if i > 1 and e[2] == keys.up then
         i = i - 1
      elseif i < 3 and e[2] == keys.down then
         i = i + 1
      elseif e[2] == keys.enter then
         if i == 1 then
            term.setCursorPos(17,4)
            write(":")
            term.setCursorPos(18,4)
            fileName = read()
            break
         elseif i == 2 then
            term.setCursorPos(19,5)
            write(":")
            term.setCursorPos(20,5)
            fileName = read()
            load(fileName)
            break
         elseif i == 3 then
            break
         end
      end
   end
   if fileName == nil then
      break
   end
   term.clear() -- start of editor
   frame.init()
   while true do
      local i = 1
      frame.init()
      repeat
         frame.setText(1,i,text[i+area_focus])
         i = i + 1
      until i == y
      frame.setText(1,y,"f1/f2: Save f3: Main Menu")
      frame.drawAll()
      input()
   end
end
